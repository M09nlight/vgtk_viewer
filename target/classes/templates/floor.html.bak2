<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<title th:text="'Этаж: ' + ${floornum} + ' Общежитие №'+ ${iddorm==3?'1':'3'}">Общежитие</title>
    <head th:replace="commons::head"></head>
    <style type="text/css">
.cinemaHall {
    text-align: center;
    display: inline-block;
    vertical-align: top;
}

.seat {
    height: 85px;
    width: 60px;
    margin: 4px;
    background-color: Silver;
    display: inline-table;
    cursor: pointer;  /* показать курсор как ссылку */
    border-radius: 2px;
    font-size: 12px;
}

.kitchen {
    height: 85px;
    width: 64px;
    margin: 4px;
    background-image: url("/img/logos/kitchen.png");
    background-size: 64px 85px;
    	background-repeat: no-repeat;
    background-color: Silver;
    display: inline-table;
    border-radius: 2px;
    font-size: 12px;
}

.bytovaya {
    height: 85px;
    width: 64px;
    margin: 4px;
    background-image: url("/img/logos/byt.png");
 	background-size: 64px 85px;
	background-repeat: no-repeat;
    background-color: Silver;
    display: inline-table;
    border-radius: 2px;
    font-size: 12px;
}

.staffonly{
    height: 85px;
    width: 64px;
    margin: 4px;
    background-image: url("/img/logos/staff.png");
    background-size: 64px 85px;
	background-repeat: no-repeat;
    background-color: Silver;
    display: inline-table;
    border-radius: 2px;
    font-size: 12px;
}

.relaxroom{
    height: 85px;
    width: 64px;
    margin: 4px;
   	background-image: url("/img/logos/relax.png");
    background-size: 64px 85px;
    background-color: Silver;
    display: inline-table;
    border-radius: 2px;
    font-size: 12px;
}

.backgroundfloor{
	height: 380px;
	border-radius: 15px;
	margin-left: auto;
    margin-right: auto;
	border-style: solid;
    width: 1200px;
    background-color: #ffffff;
}

.notSeat {
    /*height: 125px; */
    width: 50px;
    margin: 4px;
    background-color: #ffffff;
    display: inline-block;
    border-radius: 2px;
    font-size: 12px;
}

.passageBetween {
    height: 1px;
    width: 100%;
    display: block;
}

.bay {
 /*display: inline-grid; */
    background-color: red;
}

.result-border{
	border-style: groove;
	border-radius: 5px;
}
.result {
    font-size: 20px;
    display: inline-block;
    /*width: 190px; */
    border-radius: 5px;
    max-height: 200px; 
    overflow-y: auto;
    margin-right: 5px;  
    background-color: white;
    margin: 10px;
    
}

.outer{
            display: flex;
            justify-content: center;
            /*align-items: center; */ /*по вертикали*/
}

</style>
    <body>
        <div th:replace="commons::navbar"></div>
            <div th:replace="commons::nav"></div>
            
            <input type="hidden" id="dormId" th:value="${iddorm}"/>
            <input type="hidden" id="floorNum" th:value="${floornum}"/>
            <input id="forIp" th:value="${@environment.getProperty('isServer')}" hidden>
                <!-- получить значение из сервера для ip из сервера -->

                <script>
                    var ipFromAppProp;
                    if (document.getElementById("forIp").value == "false") {
                        ipFromAppProp = "127.0.0.1:8080";
                    } else {
                        ipFromAppProp = "192.168.1.5:80"
                    }
                    //console.log("new ip: " + ipFromAppProp);
                </script>
          
	<div class="outer">
		<div class='result'></div>
	</div>
	<div class="backgroundfloor" style="border-width: 1.5px;">
	<div class="cinemaHall zal1" ></div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        
        <script type="text/javascript">
        
                    async function getEnrollmentDate() {
                    	var testV1=78;
						
                        let selectedSpecialtyEl = document.getElementById("selSpec");
						var dormId = $("#dormId").val();
						var floorNum = $("#floorNum").val();
                        let url = 'http://' + ipFromAppProp + '/getPersonRoomForJS0/?idDorm='+dormId +'&floorNum=' + floorNum;
                        let response = await
                        fetch(url);

                        let commits = await
                        response.json(); //читаем ответ в формате JSON
                        console.log("is exists___commits: " + commits[0][10][1].roomNumber)
                        //console.log("is exists___commits: " + commits[5][0][0].roomNumber)
                        
                        //ijx: 0 10 1
                        //ijx: 0 10 2
                        //ijx: 0 10 3
                        //ijx: 0 14 1
                        //ijx: 0 14 2
                        //ijx: 0 14 3
                        
                        var arrFromJS = commits;

                        for(var i=0;i<commits.length;i++){
                              //console.log("textContent: " + commits[i].number)
                        }
                        
                        return commits;
                    }


                </script>
        
<script>

allActions()

function allActions(){
	
var commits
getEnrollmentDate().then((value) => {
commits=value;

//console.log("length: " + commits[0].length)
var rowsLength = 18; //ряды горизонательные //i 
var colsLength = 4; //колонки вертикальные //j

var arr = new Array(colsLength);

var arr0 = new Array(4);

for (var i = 0; i < rowsLength; i++) {
    arr0[i] = new Array(colsLength);
}

for (var i = 0; i < rowsLength; i++) {
    for (var j = 0; j < rowsLength; j++) {
    arr0[i][j] = new Array(colsLength);
    }
}

var array0 = Array(4).fill().map(e => Array(18).fill().map(e => Array(5).fill("3").map(e => e)));

for (var i = 0; i < 4; i++) {
    for (var j = 0; j < 18; j++) {
        for (var k = 0; k < 5; k++) {
        	array0[i][j][k]=commits[i][j][k]
        }
    }
}
//console.log("arrray0 :"+array0[0][3][0].isExists)

var cinemaHall1 = {
    row: [18,18,18,18]
  },
  cinemaHallMap = '';
  var rows = cinemaHall1.row.length; //количество рядов
  
  
	var cinemaStylePadding='';
	var cinemaStylePaddingB='';
  var isExistsPerson=false;
$.each(cinemaHall1.row, function(row, numberOfSeats) {
    cinemaHallRow = '';
	cinemaStylePadding='';
	cinemaStylePaddingB='';
	
  for (i = 0; i < numberOfSeats; i++) {
	isExistsPerson=false;
	cinemaStylePadding = ' '
	cinemaStylePaddingB='';
	
    if(array0[row][i][0].isExists == 1){
    	

    	var arrayOfStrings0 = 0;
    	var arrayOfStringsNext0 = 0;
        if(i!=16){
        	arrayOfStrings0 =  array0[row][i][0].roomNumber.split('-');
        	arrayOfStringsNext0 = array0[row][i+1][0].roomNumber.split('-');
        }else{
        	arrayOfStrings0[0] = arrayOfStrings0[1] = 0;
        	arrayOfStringsNext0[0]=arrayOfStringsNext0[1] = 0;
        }
        
        console.log("now: "+arrayOfStrings0[0] +" "+arrayOfStrings0[1]+" next: "+arrayOfStringsNext0[0]+" "+arrayOfStringsNext0[1])
    	
        
        if(arrayOfStrings0[0] == arrayOfStringsNext0[0]){
    	cinemaHallRow+="<div style='display: inline-table; border-style: solid; border-color: cyan; margin: 5px;'>"    	
        }
    	
    	
    var strForCard="";
      for(var e=0;e<5;e++){
    	    if(array0[row][i][e].fio==""){
    	    	//console.log("пусто")
    	    }else{ //if person is exists set href and title of card 
    	    	//console.log("imya: "+array0[row][i][e].fio)
    	    	strForCard += '<a style="display: none;" href="http://127.0.0.1:8080/person?id='  + array0[row][i][e].idPerson +'">' +  array0[row][i][e].fio +  '</a>'
    	    	isExistsPerson=true;
    	    }
    	    
    	    if(!isExistsPerson){ //if person isn't exists set that styles 
    	    cinemaStylePaddingB='style="margin-top: 10px;"';
    	    }
    	    cinemaStylePadding='style=" display: inline-grid"';
      }
      
      
      var arrayOfStringsPrevious = 0;
      if(i!=0){
    	arrayOfStringsPrevious =  array0[row][i-1][0].roomNumber.split('-');
      }else{
    	  arrayOfStringsPrevious[0]=0;
      }
      
      
      var arrayOfStrings = array0[row][i][0].roomNumber.split('-');
      
      var styleColorForCard='';
      if(isExistsPerson){
      styleColorForCard = 'style="background-color: SpringGreen;  display: inline-grid;"'; //если есть человек, то красим карточку в зелёный цвет
      }
      
      //console.log("isexistsPerson: "+ isExistsPerson + " styleColorForCard: "+styleColorForCard)
      
      cinemaHallRow += '<div ' + styleColorForCard + ' class="seat"' + cinemaStylePadding + ' data-row="' + i + '" data-seat="' +
      i + '">&nbsp;'+ '<b style="font-size: 200%; margin-top: -0.75em; margin-bottom: -0.25em;" ' +  cinemaStylePaddingB + '>' + arrayOfStrings[0]+'</b>' +
      '<hr style="margin-bottom: 0px; margin-top: 0px; height: 0">' +
      
      '<b style="font-size: 200%; margin-top: -0.35em" ' +  cinemaStylePaddingB + '>' + arrayOfStrings[1]+'</b>' +
      strForCard + '</div>';
      
      
      var arrayOfStringsPriv1 = 0;
      var arrayOfStringsNow1 = 0;
      if(i!=0){
          arrayOfStringsPriv1 = array0[row][i-1][0].roomNumber.split('-');
          arrayOfStringsNow1 =  array0[row][i][0].roomNumber.split('-');
      }else{
          arrayOfStringsPriv1[0]=arrayOfStringsPriv1[1]=0;
          arrayOfStringsNow1[0]=arrayOfStringsNow1[1]=0;
          
      }
      
      console.log("priv1: "+arrayOfStringsPriv1[0] +" "+arrayOfStringsPriv1[1]+" now1: "+arrayOfStringsNow1[0]+" "+arrayOfStringsNow1[1])
      
      if(arrayOfStringsPriv1[0]==arrayOfStringsNow1[0]){
      cinemaHallRow+="</div>"
      }
    } // if(array0[row][i][0].isExists == 1){
    
    else if(array0[row][i][0].isExists == 2){
    	var strForCard="";

    	styleColorForCard = 'style="background-color: Silver;  display: inline-grid;"'

        cinemaHallRow += '<div ' + styleColorForCard + ' class="kitchen"' + cinemaStylePadding + ' data-row="' + i + '" data-seat="' +
        i + '">&nbsp;' +
        strForCard + '</div>';
        }
    else if(array0[row][i][0].isExists == 3){
    	var strForCard="";

    	styleColorForCard = 'style="background-color: Silver;  display: inline-grid;"'

        cinemaHallRow += '<div ' + styleColorForCard + ' class="bytovaya"' + cinemaStylePadding + ' data-row="' + i + '" data-seat="' +
        i + '">&nbsp;' +
        strForCard + '</div>';
        }
    else if(array0[row][i][0].isExists == 4){
    	var strForCard="";

    	styleColorForCard = 'style="background-color: Silver;  display: inline-grid;"'

        cinemaHallRow += '<div ' + styleColorForCard + ' class="staffonly"' + cinemaStylePadding + ' data-row="' + i + '" data-seat="' +
        i + '">&nbsp;' +
        strForCard + '</div>';
        }
    else if(array0[row][i][0].isExists == 5){
    	var strForCard="";

    	styleColorForCard = 'style="background-color: Silver;  display: inline-grid;"'

        cinemaHallRow += '<div ' + styleColorForCard + ' class="relaxroom"' + cinemaStylePadding + ' data-row="' + i + '" data-seat="' +
        i + '">&nbsp;' +
        strForCard + '</div>';
        }
    else{
        cinemaHallRow += '<div class="notSeat" style="visibility: hidden" data-row="' +
      i + '" data-seat="' + i + '">'+'<div style="visibility: hidden !important;"></div>'+'</div>';
    }

  } //for (i = 0; i < numberOfSeats; i++) {
  //собираем зал с проходами между рядами
  cinemaHallMap += cinemaHallRow + '<div class="passageBetween">&nbsp;</div>';
});

//заполняем в html зал номер 1
$('.zal1').html(cinemaHallMap);
// тут по клику определяем что место выкуплено
$('.seat').on('click', function(e) {
  // если первый раз кликнули билет выкупили, 
  // если повторно значит вернули билет
  
  // если кнопка карточка серая, то ничего не делаем
  // если карточка зелёная, то меняем цвет и показывем людей из комнаты
  
  if("rgb(192, 192, 192)" != $(e.currentTarget).css("background-color")){
	  $(e.currentTarget).toggleClass('bay'); //для включение и отключения покупки
	    if("rgb(0, 255, 127)" == $(e.currentTarget).css("background-color")){
	        $(e.currentTarget).css("background-color","red") 
	   }else{
		    $(e.currentTarget).css("background-color","rgb(0, 255, 127)") 
	   }
  }
  
  //показываем сколько билетов выкуплено
  //$(e.currentTarget).removeAttribute.removeAttribute("style");
  showBaySeat();
});

function showBaySeat() {
  result = '';
  //ищем все места купленные и показываем список выкупленных мест
  $.each($('.seat.bay'), function(key, item) {
	  
	  console.log(item.childNodes[1].textContent)
	  
	  var numberOfRoom = item.childNodes[1].textContent + '/' + item.childNodes[3].textContent ; //выводим название комнаты в формате 101/3
	  result +='<div class="result-border">'
	  if($(item.getElementsByTagName('a')).length>0){
	   result +='<div class="outer"><h4> ' +numberOfRoom+ '</h4></div>'
	  }
	  
	  var content = '';
	  var href='';
	  $(item.getElementsByTagName('a')).each(function(){
		  console.log($(this).text())
		  console.log($(this).attr('href'))
		  href=$(this).attr('href');
	  result += '<a  class="ticket" style="padding: 0 10px 0 10px" href="' + href + '">'+$(this).text() +'</a><br>'; //добавить ссылку на человека
	  });
	  result +='</div>'
	  //console.log("href: "+href)
  });

  $('.result').html(result);
}

}); //then
}
         </script>
</div>
        <div class="wrapper">
            <div class="row row-cols-md-2 row-m-0">
                <div class="col-5" style="max-width: 500px;">
                    <div class="row row-cols-md-1 row-m-0">
                        <div class="card mb-3"  style="max-width: 500px;" th:each="room: ${rooms}">
                            <div class="card-header">Комната №<th:block th:text="${room.number}"/></div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li th:each="person: ${persons}" class="list-group-item" th:if="${person.room.id == room.id}">
                                            <a th:href="@{/person?id={pid}(pid=${person.id})}"><th:block th:text="${person.surname}"/>
                                            <th:block th:text="${person.name}"/>
                                            <th:block th:text="${person.patronymic}"/></a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="container" style="min-width: 700px;">
                    <div class="card mb-3" style="min-width: 750px;">
                    
                    <div class="card-header row" style="padding-left: 20px;margin-left: 0px;margin-right: 0px;">
                    <div class="col-md-9">
                        <h3>Список жильцов этажа</h3>
                    </div>
                    <div class="col-md-3" >
                        
                        <form action="/downloadWord" accept-charset="UTF-8" method="POST">
                        
                        <input type="hidden" name="idDorm" class="form-control" id="inlineFormInputGroupUsername2" 
                        placeholder="Введите фамилию" th:value="${iddorm}" value="jjj" hidden>
                        
                        <input type="hidden" name="floorNum" class="form-control" id="inlineFormInputGroupUsername2" 
                        placeholder="Введите фамилию" th:value="${floornum}" >
                        
                        <button type="submit" class="btn btn-success">Скачать Word</button>
                        
                        </form>
                    </div>
                        </div>
                        
            <table class="table table-light" style="font-size: 80%;">
            <thead>
            <tr>
            <th scope="col">Фамилия</th>
            <th scope="col">Имя</th>
            <th scope="col">Отчество</th>
            <th scope="col">Возраст</th>
            <th scope="col">Отделение</th>
            <th scope="col">Группа</th>
            <th scope="col">Комната</th>
            <th scope="col">Откуда</th>
            </tr>
            </thead>
            <tbody>
            <tr class="table-light" th:each="person: ${persons}">
                <td><th:block th:text="${person.surname}"/></td>
                <td><th:block th:text="${person.name}"/></td>
                <td><th:block th:text="${person.patronymic}"/></td>
                <td><th:block th:text="${T(by.vgtk.support.Functions).getAgeFromDate(person.dateOfBirth)}"/></td>
                <td><th:block th:if="${person.department} != null" th:text="${T(by.vgtk.support.Functions).getAbbrOtdel(person.department.departmentName)}"/></td>
                <td><th:block th:text="${person.group1.groupName}"/></td>
                <td><th:block th:text="${person.room.number}"/></td>
                <td><th:block th:text="${person.homeAddress}"/></td>

            </tr>
            </tbody>
            </table>
                            <!-- <ul class="list-group list-group-flush">
                                <li th:each="person: ${persons}" class="list-group-item">
                                    <th:block th:text="${person.surname}"/>
                                    <th:block th:text="${person.name}"/>
                                    <th:block th:text="${person.patronymic}"/>
                                    <th:block th:text="${person.room.number}"/>
                                    <th:block th:text="${person.type}"/>
                                    <th:block th:text="${person.dateOfBirth}"/>
                                </li>
                            </ul>-->
                        </div>
                    


				

			</div>
                </div>
                    
                </div>
            </div>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        <script src="https://cdn.ckeditor.com/ckeditor5/20.0.0/classic/ckeditor.js"></script>

    </body>
</html>